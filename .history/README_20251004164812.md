# 项目：OOBE 产品介绍网站

以微软 OOBE 形式展示产品信息，支持后台动态管理页数与内容，并提供“PPT/画布式”设计器。前端包含页面切换动画与 Fluent（蓝白）风格。
> 重要必读（避免 ENOENT）
> - 请不要在项目根目录直接执行 npm run ...（根目录没有 package.json）。
> - 应分别进入 backend/ 与 frontend/ 目录执行各自的 npm 脚本。
> - 如果在根目录看到类似“ENOENT: no such file or directory, open '...\\package.json'”，请切换到对应子目录再执行命令。

## TL;DR 快速启动（开发）

后端（终端 A）
```powershell
cd .\backend
npm install
npm run start:dev
```

前端（终端 B）
```powershell
cd ..\frontend
npm install
npm run dev
```

打开
- OOBE： http://localhost:3001/oobe/1
- 管理后台： http://localhost:3001/admin

提示
- 后端固定监听 3000（见 [backend/src/main.ts](backend/src/main.ts:1)）。
- 前端如 3000 被占用，会提示并改用 3001。

## 一键开启两个终端（PowerShell，可选）

在项目根目录执行以下两行，会分别启动后端与前端的独立 PowerShell 窗口并保持打开：

```powershell
Start-Process powershell -ArgumentList '-NoExit','-Command','cd .\backend; npm install; npm run start:dev'
Start-Process powershell -ArgumentList '-NoExit','-Command','cd .\frontend; npm install; npm run dev'
```

或使用绝对路径（适用于你的当前环境）：
```powershell
Start-Process powershell -ArgumentList '-NoExit','-Command','cd C:\Users\VE\Desktop\project-welcome-xiya\backend; npm install; npm run start:dev'
Start-Process powershell -ArgumentList '-NoExit','-Command','cd C:\Users\VE\Desktop\project-welcome-xiya\frontend; npm install; npm run dev'
```

## 常见错误快速修复

- ENOENT: cannot find package.json
  - 原因：在根目录执行了 npm run ...
  - 处理：分别进入 backend/ 或 frontend/ 目录再执行命令，例如：
    ```powershell
    cd .\backend
    npm run start:dev
    ```
    ```powershell
    cd .\frontend
    npm run dev
    ```

## 技术栈
- 后端：NestJS + Prisma（SQLite），REST API，端口 3000，前缀 /api/v1
- 前端：Next.js（App Router）+ Ant Design v5，端口通常为 3001（如 3000 被占用则自动 3001）
- 语言：TypeScript

## 目录结构
```
.
├─ backend/              # NestJS 后端
│  ├─ src/               # 业务代码（控制器/服务/模块）
│  ├─ prisma/            # Prisma schema、migrations、dev.db
│  └─ .env               # 数据库连接（SQLite）
└─ frontend/             # Next.js 前端
   └─ src/app/           # App Router 页面与样式
```

关键文件：
- 后端入口与 CORS：[backend/src/main.ts](backend/src/main.ts:1)
- OOBE 资源（控制器/服务）：[backend/src/oobe/oobe.controller.ts](backend/src/oobe/oobe.controller.ts:1)、[backend/src/oobe/oobe.service.ts](backend/src/oobe/oobe.service.ts:1)
- Prisma 模型与映射：[backend/prisma/schema.prisma](backend/prisma/schema.prisma:1)
- 前端 OOBE 展示页（含动画）：[frontend/src/app/oobe/[step]/page.tsx](frontend/src/app/oobe/%5Bstep%5D/page.tsx:1)
- 前端 OOBE 设计器页：[/frontend/src/app/admin/designer/[id]/page.tsx](frontend/src/app/admin/designer/%5Bid%5D/page.tsx:1)
- 全局样式（Fluent 风格与过渡动画）：[frontend/src/app/globals.css](frontend/src/app/globals.css:1)
- 兼容层（开发警告处理）：[frontend/src/app/compat-provider.tsx](frontend/src/app/compat-provider.tsx:1)
- 布局入口：[frontend/src/app/layout.tsx](frontend/src/app/layout.tsx:1)

## 环境要求（Windows 11 推荐）
- Node.js 18.x 或 20.x
- npm 9+（或使用 pnpm/yarn，但脚本示例使用 npm）

## 快速启动（开发环境）

1) 安装依赖

在两个终端分别执行：

后端（终端 A）

```
cd .\backend
npm install
```

前端（终端 B）

```
cd ..\frontend
npm install
```

2) 启动服务

后端（终端 A）

```
npm run start:dev
```

前端（终端 B）

```
npm run dev
```

3) 打开页面
- 产品 OOBE： http://localhost:3001/oobe/1
- 管理后台： http://localhost:3001/admin

注意：如果前端占用端口 3000，则 Next.js 会自动使用 3001；后端固定监听 3000。

## 后端配置说明

- 数据库连接位于 [.env](backend/.env:1)，默认 SQLite，例如：

```
DATABASE_URL="file:./prisma/dev.db"
```

- 初次或更新 Prisma 模型后，可运行：

```
cd .\backend
npx prisma migrate dev
npx prisma generate
```

- API 基础地址（前端使用）： http://localhost:3000/api/v1

- 已启用 CORS，默认允许 http://localhost:3001 访问（见 [main.ts](backend/src/main.ts:1)）。

## 前端功能与配置

- OOBE 展示页会解析后端的 content 字段：
  - 新结构：`{ canvas: { width, height, backgroundUrl }, blocks: Block[] }`
  - 旧结构：`Block[]`（仅块数组，向后兼容）
- 画布宽高与背景图在展示页生效：
  - 卡片宽度遵循 `canvas.width` 像素，且 `max-width: 95vw`，以适配不同屏幕。
  - 内部画布按 `aspect-ratio: canvas.width / canvas.height` 保持比例，背景图 `cover + center`。
- 页面切换动画：
  - 点击 Next 时：当前页“向左滑出”，新页“从右滑入”。
  - 点击 Previous 时：当前页“向右滑出”，新页“从左滑入”。
  - 动画样式定义见 [globals.css](frontend/src/app/globals.css:170)；逻辑触发见 [OOBE 页面](frontend/src/app/oobe/%5Bstep%5D/page.tsx:80,frontend/src/app/oobe/%5Bstep%5D/page.tsx:125)。
- Fluent UI 风格调优：全局字体、卡片、按钮样式见 [globals.css](frontend/src/app/globals.css:1)。

## 管理后台使用指南

- 入口： http://localhost:3001/admin
- 列表页支持增删改查 OOBE 页面：
  - 新建/编辑时填写：pageNumber（页码）、title（标题）、content（文本或 JSON）。
  - “Design” 按钮可打开设计器。
- 设计器（画布式）：
  - 访问示例：`/admin/designer/1`（将 1 替换为具体页面 id）
  - 支持拖拽块（title/text/image）、编辑文本（contentEditable）、调整属性（x/y/w/h/image URL）。
  - Canvas 面板可设置画布宽度、高度与背景图片 URL。
  - 保存后后端 content 字段会存储为 JSON：`{ canvas, blocks }`。
- 展示页会按百分比渲染块的位置与尺寸，确保不同设备下视觉一致。

## 常见问题与排查

1) 前端端口不是 3001？
   - Next.js 默认 3000，如被后端占用会自动切换到 3001。请以终端提示为准。

2) CORS 报错（跨域）？
   - 确认后端已允许前端来源（见 [backend/src/main.ts](backend/src/main.ts:1)）。
   - 如前端端口不是 3001，请调整后端 CORS origin。

3) 内容保存后展示不生效？
   - 确认设计器保存后 content 为新结构：`{ canvas, blocks }`。
   - 刷新页面或检查浏览器网络请求是否成功。

4) AntD 兼容提示（React 19）？
   - 开发环境已通过 [compat-provider.tsx](frontend/src/app/compat-provider.tsx:1) 过滤特定警告。
   - 可按官方指南升级兼容包以彻底移除提示。

5) 开发覆盖样式导致卡片宽度固定？
   - 全局 `.oobe-card` 已改为 `width: auto; max-width: 95vw`，具体宽度由展示页内联样式控制。

## 常用脚本

后端：
```
cd .\backend
npm run start:dev
npm run build
npm run start:prod
```

前端：
```
cd .\frontend
npm run dev
npm run build
npm run start
```

## 部署建议（概述）

- 后端：
  - 数据库可换为 PostgreSQL/MySQL 并更新 [schema.prisma](backend/prisma/schema.prisma:1) 与 .env。
  - 生产环境建议开启 HTTPS 与严格 CORS。
- 前端：
  - 将 API 基础地址改为环境变量（例如 `NEXT_PUBLIC_API_BASE`），并在构建时注入。
  - 使用静态资源 CDN 提升背景图片加载速度。

## 访问入口一览
- OOBE 第 1 页： http://localhost:3001/oobe/1
- 管理后台： http://localhost:3001/admin
- 设计器（示例）： http://localhost:3001/admin/designer/1

## 许可

本项目用于演示与内部评估，无特殊开源许可声明。请在生产环境遵循相关合规与安全要求。